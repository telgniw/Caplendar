<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>地圖行事曆</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/cupertino/jquery-ui-1.8.12.custom.css">	
  <script type="text/javascript" src="/js/jquery-1.5.1.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
</head>
<body>
  <script type="text/javascript">
    $(function() {
      $.getScript('http://connect.facebook.net/zh_TW/all.js', function() {
        FB.init({
          apiKey: '{{ facebook_api_key }}', appId: '{{ facebook_app_id }}', cookie: true, status: true
        });
        FB.Event.subscribe('auth.{% if current_user %}logout{% else %}login{% endif %}', function() {
          window.location.reload();
        });
        $('.xfbml').each(function() {
          FB.XFBML.parse(this);
        });
      });
      $.getScript('/js/jquery-ui-1.8.12.custom.min.js', function() {
        $('#accordion').accordion({
          header: 'h3',
          fillSpace: true
        });
        $('#draggable').draggable({
          axis: 'y',
          cursor: 'move'
        });
      });
      $('.calendar-event').each(function() {
        $(this).hover(function() {
          $(this).addClass('ui-state-hover');
          $(this).css('cursor', 'pointer');
          var close = $('<span class="ui-icon ui-icon-close ui-corner-all"></span>').mouseenter(function() {
            $(this).addClass('ui-icon-closethick');
          }).mouseleave(function() {
            $(this).removeClass('ui-icon-closethick');
          }).css('float', 'right');
          $(this).prepend(close);
        }, function() {
          $(this).removeClass('ui-state-hover');
          $(this).css('cursor', 'auto');
          $('span.ui-icon-close').detach();
        });
      });
    });
  </script>
  <div id="fb-root">
    <div id="l">
      <div id="map">
      </div>
      <script type="text/javascript">
      var map = new google.maps.Map($('#map')[0], {
        zoom: 12,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });
      </script>
    </div>
    <div id="r">
      <div id="accordion">
        <div class="accordion-item">
          <h3><a href="#">主選單</a></h3>
          <div class="accordion-content">
            <div class="xfbml">
              <span><fb:like-box width="250" href="http://www.facebook.com/apps/application.php?id=208577865834024" stream="false" header="false" show_faces="false"></fb:like-box></span>
              <span>
                <fb:login-button autologoutlink="true" perms="{{ permission }}"></fb:login-button>
                {% if current_user %}
                Hello, {{ current_user.name|escape }}.
                {% endif %}
              </span>
              <span><fb:friendpile width="250" max_rows="1"></fb:friendpile></span>
            </div>
           {% if current_user %}
            <div id="calendar-header" class="ui-widget-header ui-corner-top ui-state-default">行事曆</div>
            <div id="calendar" class="ui-widget-content ui-corner-bottom">
              <div id="draggable">
                {% for event in calendar %}
                <span id="{{ event.key }}" class="calendar-event ui-state-default ui-corner-all">
                  <span class="calendar-title">{{ event.title }}</span>
                  <span class="calendar-time">{{ event.time|date:"Y-m-d H:i" }}</span>
                  <script type="text/javascript">
                  var place = new google.maps.LatLng({{ event.place.lat }}, {{ event.place.lon }});
                  new google.maps.Marker({
                    title: '{{ event.title }}',
                    position: place,
                    map: map
                  });
                  map.setCenter(place);
                  </script>
                </span>
                {% endfor %}
              </div>
            </div>
            {% else %}
            <script type="text/javascript">
              map.setZoom(7);
              map.setCenter(new google.maps.LatLng(24.0105125, 121.0404772));
            </script>
            {% endif %}
          </div>
        </div>
        {% if current_user %}
        <div class="accordion-item">
          <h3><a href="#">選項</a></h3>
          <div class="accordion-content">
            <span>Hello World!</span>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</body>
</html>
